<!-- ULTRA-FAST LIVE FEED TEMPLATE - SUB-2 SECOND LOADING -->
{% extends 'base.html' %}

{% block title %} ULTRA-FAST Live Feed {% endblock title %}

{% block content %}

{% load static %} 

<link rel="stylesheet" type="text/css" href="{% static 'css/live-feed.css' %}">

<!-- Ultra-Fast Loading Indicator -->
<div id="ultra-loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 9999;">
    <div style="text-align: center;">
        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
        <div>âš¡ ULTRA-FAST Loading...</div>
        <div style="font-size: 0.8em; color: #aaa;">Target: SUB-2 seconds</div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.ultra-fast-controls {
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    color: white;
}

.ultra-fast-controls h2 {
    margin: 0 0 10px 0;
    font-size: 1.4em;
}

.ultra-fast-status {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 10px;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #00ff00;
    box-shadow: 0 0 10px #00ff00;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.camera-assignment {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.assignment-item {
    background: rgba(255,255,255,0.1);
    padding: 8px;
    border-radius: 5px;
    font-size: 0.9em;
}

.grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-top: 20px;
}

.camera-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.camera-card:hover {
    transform: translateY(-2px);
}

.camera-wrapper {
    position: relative;
    width: 100%;
    height: 300px;
    background: #f0f0f0;
    border-radius: 8px;
    overflow: hidden;
}

.camera-frame {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}

.camera-status {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    z-index: 10;
}
</style>

<!-- Ultra-Fast Controls Header -->
<div class="ultra-fast-controls">
    <h2>âš¡ ULTRA-FAST Live Feed System</h2>
    <div class="ultra-fast-status">
        <span class="status-indicator"></span>
        <span><strong>Status:</strong> LIGHTNING ACTIVE</span>
        <span><strong>Target:</strong> SUB-2 Second Loading</span>
        <span><strong>System:</strong> {{ system_name }}</span>
    </div>
    
    <div class="camera-assignment">
        <div class="assignment-item">
            <strong>ðŸ“¹ Camera 0:</strong> Acer HD (User-Facing)
        </div>
        <div class="assignment-item">
            <strong>ðŸ“¹ Camera 1:</strong> Rapoo Camera
        </div>
        <div class="assignment-item">
            <strong>ðŸ“µ Camera 2:</strong> No Input
        </div>
        <div class="assignment-item">
            <strong>ðŸ“µ Camera 3:</strong> No Input
        </div>
    </div>
</div>

<!-- Control buttons -->
<div class="controls" style="margin-bottom: 20px;">
    <a href="{% url 'recording_archive' %}" class="btn" style="background-color: var(--primary-color); color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-right: 10px;">
        <i class="fas fa-archive"></i> Archive
    </a>
    <a href="{% url 'face_logs' %}" class="btn" style="background-color: var(--primary-color); color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-right: 10px;">
        <i class="fas fa-user"></i> Face Logs
    </a>
    <button onclick="refreshAllCameras()" class="btn" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer;">
        <i class="fas fa-sync"></i> Ultra Refresh
    </button>
</div>

<!-- ULTRA-FAST Camera Grid Layout -->
<div class="grid" id="camera-grid">
    {% for camera_id in camera_ids %}
        <div class="camera-card" id="camera-card-{{ camera_id }}">
            <h3>
                {% if camera_id == 0 %}
                    ðŸ“¹ Camera {{ camera_id }} - Acer HD (User-Facing)
                {% elif camera_id == 1 %}
                    ðŸ“¹ Camera {{ camera_id }} - Rapoo Camera
                {% else %}
                    ðŸ“µ Camera {{ camera_id }} - No Input
                {% endif %}
            </h3>
            <div class="camera-wrapper">
                <div class="loading-overlay" id="loading-{{ camera_id }}">
                    âš¡ Loading...
                </div>
                <img class="camera-frame" 
                     id="camera-{{ camera_id }}"
                     src="{% url 'ultra_fast_video_feed' camera_id=camera_id %}" 
                     alt="Camera {{ camera_id }}"
                     onload="hideLoading({{ camera_id }})"
                     onerror="showError({{ camera_id }})">
                <div class="camera-status" id="status-{{ camera_id }}">
                    {% if camera_id <= 1 %}ACTIVE{% else %}NO INPUT{% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>

{% if not camera_ids %}
    <p class="no-cameras">No cameras are currently available. Please check back later.</p>
{% endif %}

<script>
// Ultra-fast loading management
let loadStartTime = Date.now();
let camerasLoaded = 0;
const totalCameras = {{ camera_ids|length }};

// Show loading indicator
document.getElementById('ultra-loading').style.display = 'block';

function hideLoading(cameraId) {
    const loadingOverlay = document.getElementById('loading-' + cameraId);
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
    
    camerasLoaded++;
    
    // Check if all cameras loaded
    if (camerasLoaded >= totalCameras) {
        const totalTime = (Date.now() - loadStartTime) / 1000;
        console.log(`âš¡ ULTRA-FAST loading complete in ${totalTime.toFixed(2)}s`);
        
        // Hide main loading indicator
        document.getElementById('ultra-loading').style.display = 'none';
        
        // Show success message if under target
        if (totalTime < 2.0) {
            showSuccessMessage(`ðŸŽ¯ TARGET ACHIEVED! Loaded in ${totalTime.toFixed(2)}s`);
        } else if (totalTime < 3.0) {
            showSuccessMessage(`âš¡ Fast loading: ${totalTime.toFixed(2)}s`);
        }
    }
}

function showError(cameraId) {
    const loadingOverlay = document.getElementById('loading-' + cameraId);
    if (loadingOverlay) {
        loadingOverlay.innerHTML = 'âŒ Error';
        loadingOverlay.style.background = 'rgba(255,0,0,0.8)';
    }
    
    const status = document.getElementById('status-' + cameraId);
    if (status) {
        status.innerHTML = 'ERROR';
        status.style.background = 'rgba(255,0,0,0.8)';
    }
    
    camerasLoaded++;
    if (camerasLoaded >= totalCameras) {
        document.getElementById('ultra-loading').style.display = 'none';
    }
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #00ff00, #32cd32);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        font-weight: bold;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,255,0,0.3);
    `;
    successDiv.innerHTML = message;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

function refreshAllCameras() {
    console.log('ðŸ”„ Ultra-fast refresh initiated...');
    
    // Reset counters
    camerasLoaded = 0;
    loadStartTime = Date.now();
    
    // Show loading overlays
    for (let i = 0; i < totalCameras; i++) {
        const loading = document.getElementById('loading-' + i);
        if (loading) {
            loading.style.display = 'flex';
            loading.innerHTML = 'âš¡ Refreshing...';
            loading.style.background = 'rgba(0,0,0,0.8)';
        }
    }
    
    // Refresh all camera images
    document.querySelectorAll('.camera-frame').forEach((img, index) => {
        const timestamp = Date.now();
        const baseUrl = img.src.split('?')[0];
        img.src = baseUrl + '?t=' + timestamp;
    });
    
    showSuccessMessage('âš¡ Ultra-fast refresh initiated!');
}

// Auto-refresh every 30 seconds for optimal performance
setInterval(() => {
    console.log('ðŸ”„ Auto ultra-refresh...');
    refreshAllCameras();
}, 30000);

console.log('âš¡ ULTRA-FAST Live Feed System initialized');
console.log('ðŸŽ¯ Target: SUB-2 second loading');
</script>

{% endblock content %}