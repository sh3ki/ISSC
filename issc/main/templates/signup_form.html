{% extends 'base.html' %}

{% load static %}

{% block title %} Signup {% endblock title %}

{% block content %}
  <!-- Signup Form -->
    <!-- Display error message if exists -->
    {% if error %}
    <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 15px; border: 1px solid #f5c6cb; border-radius: 5px; margin-bottom: 20px;">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Display success message if exists -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="background-color: #d4edda; color: #155724; padding: 15px; border: 1px solid #c3e6cb; border-radius: 5px; margin-bottom: 20px;">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form class="forms" method="post">
        {% csrf_token %}
        <div class="form-group">
            <div class="form-field username">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required  readonly>
            </div>

            <div class="form-field first-name">
                <label for="first_name">First Name:</label>
                <input type="text" id="first_name" name="first_name" value="{{ form_data.first_name|default:'' }}" required>
            </div>

            <div class="form-field middle-name">
                <label for="middle_name">Middle Name:</label>
                <input type="text" id="middle_name" name="middle_name" value="{{ form_data.middle_name|default:'' }}">
            </div>

            <div class="form-field last-name">
                <label for="last_name">Last Name:</label>
                <input type="text" id="last_name" name="last_name" value="{{ form_data.last_name|default:'' }}" required>
            </div>

            <div class="form-field email">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" value="{{ form_data.email|default:'' }}" required>
            </div>

            <div class="form-field id-number">
                <label for="id_number">ID Number:</label>
                <input type="text" id="id_number" name="id_number" required readonly>
            </div>

            <div class="form-field contact-number">
                <label for="contact_number">Contact Number:</label>
                <input type="text" id="contact_number" name="contact_number" value="{{ form_data.contact_number|default:'' }}">
            </div>

            <div class="form-field gender">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender">
                    <option value="M" {% if form_data.gender == 'M' %}selected{% endif %}>Male</option>
                    <option value="F" {% if form_data.gender == 'F' %}selected{% endif %}>Female</option>
                    <option value="O" {% if form_data.gender == 'O' %}selected{% endif %}>Other</option>
                </select>
            </div>

            <div class="form-field department">
                <label for="department">Department:</label>
                <select id="department" name="department">
                    <option value="BSIT" {% if form_data.department == 'BSIT' %}selected{% endif %}>BSIT</option>
                    <option value="BSENT" {% if form_data.department == 'BSENT' %}selected{% endif %}>BSENT</option>
                    <option value="BTLED" {% if form_data.department == 'BTLED' %}selected{% endif %}>BTLED</option>
                </select>
            </div>

            <div class="form-field privilege">
                <label for="privilege">Privilege:</label>
                <select id="privilege" name="privilege">
                    <option value="student" {% if form_data.privilege == 'student' %}selected{% endif %}>Student</option>
                    <option value="faculty" {% if form_data.privilege == 'faculty' %}selected{% endif %}>Faculty</option>
                    <option value="admin" {% if form_data.privilege == 'admin' %}selected{% endif %}>Admin</option>
                </select>
            </div>

            <div class="form-field status">
                <label for="status">Status:</label>
                <select id="status" name="status">
                    <option value="allowed" {% if form_data.status == 'allowed' %}selected{% endif %}>Allowed</option>
                    <option value="restricted" {% if form_data.status == 'restricted' %}selected{% endif %}>Restricted</option>
                </select>
            </div>

            <div class="form-field password full-width">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
        </div>

        <div class="register-btn">
            <button type="submit">Register</button>
        </div>
    </form>


<script type="text/javascript">
  function fetchGeneratedId(userType) {
    fetch(`/get-user/?type=${userType}`)
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok.');
        return response.json();
      })
            .then(data => {
                console.log(`Generated ID for ${userType}:`, data);
                if (data.id_number) document.getElementById('id_number').value = data.id_number;
                // Use returned username if provided (new API returns both username and id_number)
                if (data.username) {
                    document.getElementById('username').value = data.username;
                } else if (data.id_number) {
                    document.getElementById('username').value = data.id_number;
                }
            })
      .catch(error => console.error('Error fetching ID:', error));
  }

  document.addEventListener('DOMContentLoaded', function () {
    const privilegeSelect = document.getElementById('privilege');

    // Fetch ID on page load (default: student)
    fetchGeneratedId(privilegeSelect.value);

    // Refetch ID when the user changes privilege type
    privilegeSelect.addEventListener('change', function () {
      fetchGeneratedId(this.value);
    });
  });
</script>

{% endblock content %}
