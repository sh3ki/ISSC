{% extends 'base.html' %}

{% load static %}

{% block title %} {% if is_edit_mode %}Edit Account{% else %}Create Account{% endif %} {% endblock title %}

{% block content %}
  <!-- Back Button -->
  <div style="margin-bottom: 20px;">
    <a href="{% url 'signup' %}" style="background-color: #7a1818; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: 500;">← Back to Accounts</a>
  </div>

  <!-- Signup Form -->
    <!-- Display error message if exists -->
    {% if error %}
    <div class="alert alert-danger" style="background-color: #f8d7da; color: #721c24; padding: 15px; border: 1px solid #f5c6cb; border-radius: 5px; margin-bottom: 20px;">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Display success message if exists -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="background-color: #d4edda; color: #155724; padding: 15px; border: 1px solid #c3e6cb; border-radius: 5px; margin-bottom: 20px;">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form class="forms" method="post">
        {% csrf_token %}
        <div class="form-group">
            <div class="form-field username">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" value="{% if is_edit_mode %}{{ account.username }}{% endif %}" required{% if is_edit_mode %} readonly{% endif %}>
                {% if not is_edit_mode %}
                <small id="username-hint" style="color: #666; font-size: 12px; display: block; margin-top: 4px;"></small>
                <small id="username-error" style="color: #dc3545; font-size: 12px; display: none; margin-top: 2px;"></small>
                {% endif %}
            </div>

            <div class="form-field first-name">
                <label for="first_name">First Name:</label>
                <input type="text" id="first_name" name="first_name" value="{% if is_edit_mode %}{{ account.first_name }}{% else %}{{ form_data.first_name|default:'' }}{% endif %}" required>
            </div>

            <div class="form-field middle-name">
                <label for="middle_name">Middle Name:</label>
                <input type="text" id="middle_name" name="middle_name" value="{% if is_edit_mode %}{{ account.middle_name }}{% else %}{{ form_data.middle_name|default:'' }}{% endif %}">
            </div>

            <div class="form-field last-name">
                <label for="last_name">Last Name:</label>
                <input type="text" id="last_name" name="last_name" value="{% if is_edit_mode %}{{ account.last_name }}{% else %}{{ form_data.last_name|default:'' }}{% endif %}" required>
            </div>

            <div class="form-field email">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" value="{% if is_edit_mode %}{{ account.email }}{% else %}{{ form_data.email|default:'' }}{% endif %}" required>
            </div>

            <div class="form-field id-number">
                <label for="id_number">ID Number:</label>
                <input type="text" id="id_number" name="id_number" value="{% if is_edit_mode %}{{ account.id_number }}{% endif %}" required readonly>
            </div>

            <div class="form-field contact-number">
                <label for="contact_number">Contact Number:</label>
                <input type="text" id="contact_number" name="contact_number" value="{% if is_edit_mode %}{{ account.contact_number }}{% else %}{{ form_data.contact_number|default:'' }}{% endif %}">
            </div>

            <div class="form-field gender">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender">
                    <option value="M" {% if is_edit_mode and account.gender == 'M' or form_data.gender == 'M' %}selected{% endif %}>Male</option>
                    <option value="F" {% if is_edit_mode and account.gender == 'F' or form_data.gender == 'F' %}selected{% endif %}>Female</option>
                    <option value="O" {% if is_edit_mode and account.gender == 'O' or form_data.gender == 'O' %}selected{% endif %}>Other</option>
                </select>
            </div>

            <div class="form-field department">
                <label for="department">Department:</label>
                <select id="department" name="department">
                    <option value="BSIT 1-1" {% if is_edit_mode and account.department == 'BSIT 1-1' or form_data.department == 'BSIT 1-1' %}selected{% endif %}>BSIT 1-1</option>
                    <option value="BSIT 1-2" {% if is_edit_mode and account.department == 'BSIT 1-2' or form_data.department == 'BSIT 1-2' %}selected{% endif %}>BSIT 1-2</option>
                    <option value="BSIT 2-1" {% if is_edit_mode and account.department == 'BSIT 2-1' or form_data.department == 'BSIT 2-1' %}selected{% endif %}>BSIT 2-1</option>
                    <option value="BSIT 2-2" {% if is_edit_mode and account.department == 'BSIT 2-2' or form_data.department == 'BSIT 2-2' %}selected{% endif %}>BSIT 2-2</option>
                    <option value="BSIT 3-1" {% if is_edit_mode and account.department == 'BSIT 3-1' or form_data.department == 'BSIT 3-1' %}selected{% endif %}>BSIT 3-1</option>
                    <option value="BSIT 3-2" {% if is_edit_mode and account.department == 'BSIT 3-2' or form_data.department == 'BSIT 3-2' %}selected{% endif %}>BSIT 3-2</option>
                    <option value="BSIT 4-1" {% if is_edit_mode and account.department == 'BSIT 4-1' or form_data.department == 'BSIT 4-1' %}selected{% endif %}>BSIT 4-1</option>
                    <option value="BSENT 1-1" {% if is_edit_mode and account.department == 'BSENT 1-1' or form_data.department == 'BSENT 1-1' %}selected{% endif %}>BSENT 1-1</option>
                    <option value="BSENT 1-2" {% if is_edit_mode and account.department == 'BSENT 1-2' or form_data.department == 'BSENT 1-2' %}selected{% endif %}>BSENT 1-2</option>
                    <option value="BSENT 2-1" {% if is_edit_mode and account.department == 'BSENT 2-1' or form_data.department == 'BSENT 2-1' %}selected{% endif %}>BSENT 2-1</option>
                    <option value="BSENT 2-2" {% if is_edit_mode and account.department == 'BSENT 2-2' or form_data.department == 'BSENT 2-2' %}selected{% endif %}>BSENT 2-2</option>
                    <option value="BSENT 3-1" {% if is_edit_mode and account.department == 'BSENT 3-1' or form_data.department == 'BSENT 3-1' %}selected{% endif %}>BSENT 3-1</option>
                    <option value="BSENT 3-2" {% if is_edit_mode and account.department == 'BSENT 3-2' or form_data.department == 'BSENT 3-2' %}selected{% endif %}>BSENT 3-2</option>
                    <option value="BSENT 4-1" {% if is_edit_mode and account.department == 'BSENT 4-1' or form_data.department == 'BSENT 4-1' %}selected{% endif %}>BSENT 4-1</option>
                    <option value="BSENT 4-2" {% if is_edit_mode and account.department == 'BSENT 4-2' or form_data.department == 'BSENT 4-2' %}selected{% endif %}>BSENT 4-2</option>
                    <option value="BTLED 1-1" {% if is_edit_mode and account.department == 'BTLED 1-1' or form_data.department == 'BTLED 1-1' %}selected{% endif %}>BTLED 1-1</option>
                    <option value="BTLED 1-2" {% if is_edit_mode and account.department == 'BTLED 1-2' or form_data.department == 'BTLED 1-2' %}selected{% endif %}>BTLED 1-2</option>
                    <option value="BTLED 2-1" {% if is_edit_mode and account.department == 'BTLED 2-1' or form_data.department == 'BTLED 2-1' %}selected{% endif %}>BTLED 2-1</option>
                    <option value="BTLED 2-2" {% if is_edit_mode and account.department == 'BTLED 2-2' or form_data.department == 'BTLED 2-2' %}selected{% endif %}>BTLED 2-2</option>
                    <option value="BTLED 3-1" {% if is_edit_mode and account.department == 'BTLED 3-1' or form_data.department == 'BTLED 3-1' %}selected{% endif %}>BTLED 3-1</option>
                    <option value="BTLED 3-2" {% if is_edit_mode and account.department == 'BTLED 3-2' or form_data.department == 'BTLED 3-2' %}selected{% endif %}>BTLED 3-2</option>
                    <option value="BTLED 4-1" {% if is_edit_mode and account.department == 'BTLED 4-1' or form_data.department == 'BTLED 4-1' %}selected{% endif %}>BTLED 4-1</option>
                    <option value="BTLED 4-2" {% if is_edit_mode and account.department == 'BTLED 4-2' or form_data.department == 'BTLED 4-2' %}selected{% endif %}>BTLED 4-2</option>
                </select>
            </div>

            <div class="form-field privilege">
                <label for="privilege">Privilege:</label>
                <select id="privilege" name="privilege" {% if is_edit_mode %}disabled{% endif %}>
                    <option value="student" {% if is_edit_mode and account.privilege == 'student' or form_data.privilege == 'student' %}selected{% endif %}>Student</option>
                    <option value="faculty" {% if is_edit_mode and account.privilege == 'faculty' or form_data.privilege == 'faculty' %}selected{% endif %}>Faculty</option>
                    <option value="admin" {% if is_edit_mode and account.privilege == 'admin' or form_data.privilege == 'admin' %}selected{% endif %}>Admin</option>
                </select>
                {% if is_edit_mode %}
                <input type="hidden" name="privilege" value="{{ account.privilege }}">
                {% endif %}
            </div>

            <div class="form-field status">
                <label for="status">Status:</label>
                <select id="status" name="status">
                    <option value="allowed" {% if is_edit_mode and account.status == 'allowed' or form_data.status == 'allowed' %}selected{% endif %}>Allowed</option>
                    <option value="restricted" {% if is_edit_mode and account.status == 'restricted' or form_data.status == 'restricted' %}selected{% endif %}>Restricted</option>
                </select>
            </div>
        </div>

        {% if is_edit_mode %}
        <div class="register-btn" style="display: flex; gap: 10px; justify-content: center;">
            <button type="submit" name="update" style="background-color: #28a745; padding: 12px 30px;">Update</button>
            <button type="submit" name="delete" style="background-color: #dc3545; padding: 12px 30px;" onclick="return confirm('Are you sure you want to delete this account? This action cannot be undone.');">Delete</button>
        </div>
        {% else %}
        <div class="register-btn">
            <button type="submit">Register</button>
        </div>
        {% endif %}
    </form>


<script type="text/javascript">
  {% if not is_edit_mode %}
  const USERNAME_FORMATS = {
    student: { re: /^\d{4}-\d{5}-CL-\d+$/, hint: 'Format: XXXX-XXXXX-CL-X  (e.g. 2022-00001-CL-0)' },
    faculty: { re: /^\d{5}$/, hint: 'Format: exactly 5 digits  (e.g. 00001)' },
    admin:   { re: null, hint: 'Auto-generated by system' }
  };

  function fetchGeneratedId(userType) {
    fetch(`/get-user/?type=${userType}`)
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok.');
        return response.json();
      })
      .then(data => {
        if (data.id_number) document.getElementById('id_number').value = data.id_number;
        if (data.username) {
          document.getElementById('username').value = data.username;
        } else if (data.id_number) {
          document.getElementById('username').value = data.id_number;
        }
      })
      .catch(error => console.error('Error fetching ID:', error));
  }

  function setUsernameMode(privilege) {
    const usernameInput = document.getElementById('username');
    const hintEl = document.getElementById('username-hint');
    const errEl  = document.getElementById('username-error');
    const fmt = USERNAME_FORMATS[privilege] || {};

    hintEl.textContent = fmt.hint || '';
    errEl.style.display = 'none';
    errEl.textContent  = '';

    if (privilege === 'admin') {
      usernameInput.readOnly = true;
      usernameInput.style.backgroundColor = '#e9ecef';
      fetchGeneratedId('admin');
    } else {
      usernameInput.readOnly = false;
      usernameInput.style.backgroundColor = '';
      usernameInput.value = '';
      document.getElementById('id_number').value = '';
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const privilegeSelect = document.getElementById('privilege');
    const usernameInput   = document.getElementById('username');
    const idNumberInput   = document.getElementById('id_number');
    const errEl           = document.getElementById('username-error');

    // Initialise for default privilege on page load
    setUsernameMode(privilegeSelect.value);

    // When privilege changes: reset username field and show new hint
    privilegeSelect.addEventListener('change', function () {
      setUsernameMode(this.value);
    });

    // Mirror username → id_number as the user types; clear inline error
    usernameInput.addEventListener('input', function () {
      idNumberInput.value = this.value;
      errEl.style.display = 'none';
    });

    // Client-side format validation on submit
    document.querySelector('form.forms').addEventListener('submit', function (e) {
      const privilege = privilegeSelect.value;
      if (privilege === 'admin') return; // admin is auto-generated, always valid
      const username = usernameInput.value.trim();
      const fmt = USERNAME_FORMATS[privilege];
      if (fmt && fmt.re && !fmt.re.test(username)) {
        e.preventDefault();
        errEl.textContent  = 'Invalid format. ' + (fmt.hint || '');
        errEl.style.display = 'block';
        usernameInput.focus();
      }
    });
  });
  {% endif %}
</script>

{% endblock content %}
