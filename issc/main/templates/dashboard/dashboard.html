{% extends 'base.html' %}

{% block title %} Dashboard {% endblock title %}

{% block content %}

{% load static %}

<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="dashboard-wrapper">
  <h2>Incident Overview & Analytics</h2>

  <!-- Filter Section -->
  <div class="filter-section">
    <form method="get" id="yearFilterForm" class="filter-form">
      <div class="filter-group">
        <label for="yearPicker">
          <i class="fas fa-calendar-alt"></i> Select Year:
        </label>
        <select id="yearPicker" name="year" onchange="this.form.submit()">
          {% for year in available_years %}
            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="stat-card stat-open">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-info">
        <h3>{{ status_breakdown.counts.0 }}</h3>
        <p>Open Cases</p>
      </div>
    </div>
    <div class="stat-card stat-pending">
      <div class="stat-icon">üîÑ</div>
      <div class="stat-info">
        <h3>{{ status_breakdown.counts.1 }}</h3>
        <p>Ongoing Cases</p>
      </div>
    </div>
    <div class="stat-card stat-closed">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-info">
        <h3>{{ status_breakdown.counts.2 }}</h3>
        <p>Resolved Cases</p>
      </div>
    </div>
    <div class="stat-card stat-total">
      <div class="stat-icon">üìä</div>
      <div class="stat-info">
        <h3>{{ status_breakdown.total }}</h3>
        <p>Total Active</p>
      </div>
    </div>
  </div>

  <div class="graph-container">

    <!-- Row 1: Monthly Incidents and Status Breakdown -->
    <div class="graph-section graph1">
      <h3 class="chart-title">Monthly Incident Overview ({{ selected_year }})</h3>
      <canvas id="monthlyIncidentsChart" class="chart-canvas"></canvas>
    </div>

    <div class="graph-section graph-doughnut">
      <h3 class="chart-title">Current Status Distribution ({{ selected_year }})</h3>
      <canvas id="statusBreakdownChart" class="chart-canvas"></canvas>
    </div>

    <!-- Row 2: Status Trends -->
    <div class="graph-section graph-wide">
      <h3 class="chart-title">Case Status Trends - {{ selected_year }} (Open vs Ongoing vs Closed)</h3>
      <canvas id="statusTrendsChart" class="chart-canvas"></canvas>
    </div>

    <!-- Row 3: Resolution Analysis and Incident Rate -->
    <div class="graph-section graph3">
      <h3 class="chart-title">Average Resolution Time ({{ selected_year }})</h3>
      <canvas id="resolutionTimeChart" class="chart-canvas"></canvas>
    </div>

    <div class="graph-section graph3">
      <h3 class="chart-title">Incidents by Category ({{ selected_year }})</h3>
      <canvas id="categoryTrendsChart" class="chart-canvas"></canvas>
    </div>

    <!-- Hidden graph kept for backward compatibility -->
    <div class="graph-section graph2 wide-centered-graph" style="display:none;">
      <h3 class="chart-title">Incident Type (by Subject)</h3>
      
      <form method="get" id="monthFilterForm" class="month-filter-form">
        <input type="hidden" name="year" value="{{ selected_year }}">
        <div class="filter-group-inline">
          <label for="monthPicker">
            <i class="fas fa-filter"></i> Filter by Month:
          </label>
          <input type="month" id="monthPicker" name="month" value="{{ selected_month }}">
          <button type="submit" class="filter-btn">Apply Filter</button>
          <a href="?year={{ selected_year }}" class="clear-btn">Clear</a>
        </div>
      </form>

      <canvas id="incidentTypeChart" class="chart-canvas mt-4"></canvas>
    </div>

  </div>
</div>

<script>
  const monthlyData = {{ monthly_incident_data|safe }};
  const incidentTypeData = {{ incident_type|safe }};
  const incidentRate = {{ incident_data|safe }};
  const statusBreakdown = {{ status_breakdown|safe }};
  const statusTrends = {{ status_trends|safe }};
  const resolutionAnalysis = {{ resolution_analysis|safe }};
  const categoryTrends = {{ category_trends|safe }};

  // Graph 1: Monthly Incident (Bar Chart)
  new Chart(document.getElementById('monthlyIncidentsChart'), {
    type: 'bar',
    data: {
      labels: monthlyData.months,
      datasets: [{
        label: 'Monthly Incidents',
        data: monthlyData.incident_data,
        backgroundColor: '#800000',
        borderColor: '#5a0000',
        borderWidth: 2,
        borderRadius: 8,
        hoverBackgroundColor: '#a52a2a',
        barThickness: 30,
        maxBarThickness: 40
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: {
        duration: 1000,
        easing: 'easeOutBounce'
      },
      plugins: {
        legend: { 
          display: true,
          position: 'top',
          labels: {
            font: {
              size: 13,
              weight: 'bold'
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Incidents: ' + context.parsed.y;
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14
          },
          bodyFont: {
            size: 13
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            precision: 0,
            font: {
              size: 12
            }
          },
          title: {
            display: true,
            text: 'Number of Incidents',
            font: {
              size: 14,
              weight: 'bold'
            }
          },
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.1)',
            drawBorder: true
          }
        },
        x: {
          title: {
            display: true,
            text: 'Month',
            font: {
              size: 14,
              weight: 'bold'
            }
          },
          grid: {
            display: false
          }
        }
      }
    }
  });

  // New Graph: Status Breakdown (Doughnut Chart)
  new Chart(document.getElementById('statusBreakdownChart'), {
    type: 'doughnut',
    data: {
      labels: statusBreakdown.statuses,
      datasets: [{
        data: statusBreakdown.counts,
        backgroundColor: [
          '#dc3545',  // Open - Red
          '#ffc107',  // Pending - Amber
          '#28a745'   // Closed - Green
        ],
        borderWidth: 2,
        borderColor: '#fff',
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: {
        duration: 1200,
        easing: 'easeOutQuart'
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: {
              size: 12
            },
            generateLabels: function(chart) {
              const data = chart.data;
              return data.labels.map((label, i) => ({
                text: `${label}: ${data.datasets[0].data[i]}`,
                fillStyle: data.datasets[0].backgroundColor[i],
                hidden: false,
                index: i
              }));
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return `${context.label}: ${context.parsed} (${percentage}%)`;
            }
          }
        }
      }
    }
  });

  // New Graph: Status Trends (Bar Chart with Grouped Bars)
  new Chart(document.getElementById('statusTrendsChart'), {
    type: 'bar',
    data: {
      labels: statusTrends.months,
      datasets: [
        {
          label: 'Open Cases',
          data: statusTrends.open_cases,
          backgroundColor: '#dc3545',
          borderColor: '#dc3545',
          borderWidth: 2,
          borderRadius: 6,
          hoverBackgroundColor: '#c82333',
          barThickness: 25,
          maxBarThickness: 35
        },
        {
          label: 'Ongoing Cases',
          data: statusTrends.ongoing_cases,
          backgroundColor: '#ffc107',
          borderColor: '#ffc107',
          borderWidth: 2,
          borderRadius: 6,
          hoverBackgroundColor: '#e0a800',
          barThickness: 25,
          maxBarThickness: 35
        },
        {
          label: 'Closed Cases',
          data: statusTrends.closed_cases,
          backgroundColor: '#28a745',
          borderColor: '#28a745',
          borderWidth: 2,
          borderRadius: 6,
          hoverBackgroundColor: '#218838',
          barThickness: 25,
          maxBarThickness: 35
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      animation: {
        duration: 1200,
        easing: 'easeInOutQuart'
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: false,
            padding: 15,
            font: {
              size: 13,
              weight: 'bold'
            }
          }
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14
          },
          bodyFont: {
            size: 13
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            precision: 0,
            font: {
              size: 12
            }
          },
          title: {
            display: true,
            text: 'Number of Cases',
            font: {
              size: 14,
              weight: 'bold'
            }
          },
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.1)',
            drawBorder: true
          }
        },
        x: {
          title: {
            display: true,
            text: 'Month',
            font: {
              size: 14,
              weight: 'bold'
            }
          },
          grid: {
            display: false
          }
        }
      }
    }
  });

  // New Graph: Resolution Time Analysis (Bar Chart)
  new Chart(document.getElementById('resolutionTimeChart'), {
    type: 'bar',
    data: {
      labels: resolutionAnalysis.months,
      datasets: [{
        label: 'Avg Days to Resolve',
        data: resolutionAnalysis.avg_days,
        backgroundColor: '#17a2b8',
        borderColor: '#138496',
        borderWidth: 2,
        borderRadius: 8,
        hoverBackgroundColor: '#138496',
        barThickness: 30,
        maxBarThickness: 40
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: {
        duration: 1000,
        easing: 'easeOutBounce'
      },
      plugins: {
        legend: { 
          display: true,
          position: 'top',
          labels: {
            font: {
              size: 13,
              weight: 'bold'
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Avg Days: ' + context.parsed.y.toFixed(1);
            }
          },
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14
          },
          bodyFont: {
            size: 13
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 1,
            font: {
              size: 12
            }
          },
          title: {
            display: true,
            text: 'Days',
            font: {
              size: 14,
              weight: 'bold'
            }
          },
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.1)',
            drawBorder: true
          }
        },
        x: {
          title: {
            display: true,
            text: 'Month',
            font: {
              size: 14,
              weight: 'bold'
            }
          },
          grid: {
            display: false
          }
        }
      }
    }
  });

  new Chart(document.getElementById('incidentTypeChart'), {
      type: 'bar',
      data: {
        labels: incidentTypeData.subjects,
        datasets: [{
          label: 'Incident Count',
          data: incidentTypeData.counts,
          backgroundColor: '#d63031',
          borderRadius: 6,
          hoverBackgroundColor: '#fceea3'
        }]
      },
      options: {
        responsive: true,
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        },
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index' }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              precision: 0
            },
            title: {
              display: true,
              text: 'Number of Incidents'
            }
          }
        }
      }
    });

  // Graph: Incidents by Category (Line Chart with Multiple Lines)
  new Chart(document.getElementById('categoryTrendsChart'), {
    type: 'line',
    data: {
      labels: categoryTrends.months,
      datasets: [
        {
          label: 'Theft',
          data: categoryTrends.categories.Theft,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231, 76, 60, 0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#e74c3c',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          borderDash: []
        },
        {
          label: 'Vandalism',
          data: categoryTrends.categories.Vandalism,
          borderColor: '#f39c12',
          backgroundColor: 'rgba(243, 156, 18, 0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#f39c12',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          borderDash: [5, 5]
        },
        {
          label: 'Emergency',
          data: categoryTrends.categories.Emergency,
          borderColor: '#e67e22',
          backgroundColor: 'rgba(230, 126, 34, 0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#e67e22',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          borderDash: [10, 5]
        },
        {
          label: 'Security',
          data: categoryTrends.categories.Security,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#3498db',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          borderDash: [2, 2]
        },
        {
          label: 'Harassment',
          data: categoryTrends.categories.Harassment,
          borderColor: '#9b59b6',
          backgroundColor: 'rgba(155, 89, 182, 0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#9b59b6',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          borderDash: [15, 3, 3, 3]
        },
        {
          label: 'Other',
          data: categoryTrends.categories.Other,
          borderColor: '#95a5a6',
          backgroundColor: 'rgba(149, 165, 166, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: '#95a5a6',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          borderDash: [1, 1]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      animation: {
        duration: 1200,
        easing: 'easeInOutQuart'
      },
      plugins: {
        legend: { 
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 12,
            font: {
              size: 12,
              weight: 'bold'
            }
          }
        },
        tooltip: { 
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            size: 14
          },
          bodyFont: {
            size: 13
          },
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y + ' incident(s)';
            }
          }
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            precision: 0,
            font: {
              size: 12
            }
          },
          title: { 
            display: true, 
            text: 'Number of Incidents',
            font: {
              size: 13,
              weight: 'bold'
            }
          },
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.1)'
          }
        },
        x: {
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            font: {
              size: 11
            }
          },
          title: {
            display: true,
            text: 'Month',
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        }
      }
    }
  });
</script>


{% endblock content %}
