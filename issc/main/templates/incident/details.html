{% extends 'base.html' %}

{% block title %} Incident {% endblock title %}

{% block content %} 

{% load static %} 

    <link rel="stylesheet" href="{% static 'css/details.css' %}">

    <div class="container">
        <!-- Transparent Header -->
        <div class="header">
            <h2>Incident Details</h2>
            <div style="font-size:13px;color:#666;margin-top:6px;">
                {% if incident_number %}
                    <span>Incident <strong>#{{ incident_number }}</strong> of <strong>{{ total_incidents }}</strong></span>
                {% endif %}
                {% if incident_status_number %}
                    <span style="margin-left:12px;">{{ incident.status|title }} #<strong>{{ incident_status_number }}</strong> of <strong>{{ status_count_for_incident }}</strong></span>
                    {% if incident.status == 'open' or incident.status == 'pending' %}
                        <span style="margin-left:12px;">Runtime: <strong><span id="runtime-display" data-created="{{ incident.date_joined|date:'c' }}">Calculating...</span></strong></span>
                    {% endif %}
                {% endif %}
            </div>

        </div>

        <!-- Form Section -->
        <form method="POST" enctype="multipart/form-data" class="form">
            {% csrf_token %}
        <div class="details">
            <div class="details-grid">
                <div class="col">
                    <div class="detail-field">
                        <label><strong>First Name:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="first_name" value="{{ incident.first_name }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="first_name" value="{{ incident.first_name }}">
                        {% endif %}
                    </div>

                    <div class="detail-field">
                        <label><strong>Middle Name:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="middle_name" value="{{ incident.middle_name }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="middle_name" value="{{ incident.middle_name }}">
                        {% endif %}
                    </div>

                    <div class="detail-field">
                        <label><strong>Last Name:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="last_name" value="{{ incident.last_name }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="last_name" value="{{ incident.last_name }}">
                        {% endif %}
                    </div>

                    <div class="detail-field">
                        <label><strong>Contact Number:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="contact_number" value="{{ incident.contact_number }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="contact_number" value="{{ incident.contact_number }}">
                        {% endif %}
                    </div>

                    <div class="detail-field">
                        <label><strong>ID Number:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="id_number" value="{{ incident.id_number }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="id_number" value="{{ incident.id_number }}">
                        {% endif %}
                    </div>

                    <div class="detail-field">
                        <label><strong>Subject:</strong></label>
                        <input type="text" name="subject" value="{{ incident.subject }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                    </div>

                    <div class="detail-field">
                        <label><strong>Location:</strong></label>
                        <input type="text" name="location" value="{{ incident.location }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                    </div>
                    

                    <div class="detail-field">
                        <label><strong>Reported By:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="reported_by" value="{{ incident.reported_by }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="reported_by" value="{{ incident.reported_by }}">
                        {% endif %}
                    </div>

                    <div class="detail-field">
                        <label><strong>Position:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="position" value="{{ incident.position }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="position" value="{{ incident.position }}">
                        {% endif %}
                    </div>

                    <div class="detail-field">
                        <label><strong>Department:</strong></label>
                        {% if user_role in 'student admin faculty' or incident.status == 'closed' %}
                            <input type="text" name="department" value="{{ incident.department }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                        {% else %}
                            <input type="text" name="department" value="{{ incident.department }}">
                        {% endif %}
                    </div>

                </div>

                <div class="col">
                    <div class="detail-field">
                        <label><strong>Incident:</strong></label>
                        <input type="text" name="incident" value="{{ incident.incident }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                    </div>

                    <div class="detail-field">
                        <label><strong>Request for Action:</strong></label>
                        <input type="text" name="request_for_action" value="{{ incident.request_for_action }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                    </div>

                    <div class="detail-field">
                        <label><strong>People Involved:</strong></label>
                        <input type="text" name="people_involved" value="{{ incident.people_involved }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                    </div>

                    <div class="detail-field">
                        <label><strong>Faculty Involved:</strong></label>
                        <input type="text" value="{% for faculty in incident.faculty_involved.all %}{{ faculty.first_name }} {{ faculty.last_name }} ({{ faculty.id_number }}){% if not forloop.last %}, {% endif %}{% endfor %}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                    </div>
                    
                    <div class="detail-field">
                        <label><strong>Phone Number:</strong></label>
                        <input type="text" name="phone_number" value="{{ incident.phone_number }}" readonly tabindex="-1" style="background-color:#f5f5f5;pointer-events:none;">
                    </div>

                    <div class="detail-field">
                        <label><strong>File:</strong></label>
                        {% if incident.file %}
                            <input type="text" value="Attached: {{ incident.file.name }}" disabled>
                            <p>
                                <a href="{{ incident.file.url }}" download="{{ incident.file.name }}" style="display:inline-block;padding:8px 14px;background:#2b6cb0;color:#fff;border-radius:999px;text-decoration:none;font-weight:600;" rel="noopener">Download attached file</a>
                            </p>
                        {% else %}
                            <input type="text" value="No file attached" disabled>
                        {% endif %}
                    </div>

                    <div class="detail-field small-info">
                        <p><strong>Status:</strong> {{ incident.status }}</p>
                        <p><strong>Date Joined:</strong> {{ incident.date_joined }}</p>
                        <p><strong>Date:</strong> {{ incident.date }}</p>
                        <p><strong>Time:</strong> {{ incident.time }}</p>
                        <p><strong>Last Updated:</strong> {{ incident.last_updated }}</p>
                        <p><strong>Last Updated By:</strong> {{ incident.last_updated_by }}</p>
                        <p><strong>Archived:</strong> {{ incident.is_archived }}</p>
                        {% if incident.invalidation_reason %}
                        <div style="margin-top: 12px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                            <p style="margin: 0 0 6px 0;"><strong style="color: #856404;">Invalidation Reason:</strong></p>
                            <p style="margin: 0; color: #856404; white-space: pre-wrap;">{{ incident.invalidation_reason }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        
        {% if incident.status == 'open' %}
            <!-- When status is OPEN: show Update and Delete buttons only for the creator -->
            {% if incident.reported_by == user_data.first_name|add:' '|add:user_data.last_name or incident.last_updated_by == user_data.id_number %}
                <div style="margin-top:20px;display:flex;gap:12px;">
                    <button type="button" id="open-update-modal-open" class="btn btn-primary">Update Incident</button>
                    <button type="button" id="delete-incident-btn" class="btn" style="background-color:#dc3545;color:white;">Delete Incident</button>
                </div>

                <!-- Update Modal for Open Cases -->
                    <div id="update-modal-open" class="modal" role="dialog" aria-hidden="true" style="display:none;overflow-y:auto;">
                        <div class="modal-overlay" id="modal-overlay-open" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);"></div>
                        <div class="modal-content" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:24px;border-radius:6px;max-width:800px;width:90%;max-height:85vh;overflow-y:auto;z-index:1001;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                                <h3 style="margin:0;">Update Incident Details</h3>
                                <button type="button" id="close-update-modal-open" aria-label="Close modal" style="background:none;border:0;font-size:18px;cursor:pointer;">✕</button>
                            </div>

                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                                <div>
                                    <label><strong>Location</strong></label>
                                    <select name="location" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                                        <optgroup label="1st Floor">
                                            <option value="101" {% if incident.location == '101' %}selected{% endif %}>101</option>
                                            <option value="102" {% if incident.location == '102' %}selected{% endif %}>102</option>
                                            <option value="103" {% if incident.location == '103' %}selected{% endif %}>103</option>
                                            <option value="104" {% if incident.location == '104' %}selected{% endif %}>104</option>
                                            <option value="105" {% if incident.location == '105' %}selected{% endif %}>105</option>
                                            <option value="Bathroom 1st Floor" {% if incident.location == 'Bathroom 1st Floor' %}selected{% endif %}>Bathroom 1st Floor</option>
                                        </optgroup>
                                        <optgroup label="2nd Floor">
                                            <option value="201" {% if incident.location == '201' %}selected{% endif %}>201</option>
                                            <option value="202" {% if incident.location == '202' %}selected{% endif %}>202</option>
                                            <option value="203" {% if incident.location == '203' %}selected{% endif %}>203</option>
                                            <option value="204" {% if incident.location == '204' %}selected{% endif %}>204</option>
                                            <option value="205" {% if incident.location == '205' %}selected{% endif %}>205</option>
                                            <option value="Bathroom 2nd Floor" {% if incident.location == 'Bathroom 2nd Floor' %}selected{% endif %}>Bathroom 2nd Floor</option>
                                        </optgroup>
                                        <optgroup label="3rd Floor">
                                            <option value="301" {% if incident.location == '301' %}selected{% endif %}>301</option>
                                            <option value="302" {% if incident.location == '302' %}selected{% endif %}>302</option>
                                            <option value="303" {% if incident.location == '303' %}selected{% endif %}>303</option>
                                            <option value="304" {% if incident.location == '304' %}selected{% endif %}>304</option>
                                            <option value="305" {% if incident.location == '305' %}selected{% endif %}>305</option>
                                            <option value="Bathroom 3rd Floor" {% if incident.location == 'Bathroom 3rd Floor' %}selected{% endif %}>Bathroom 3rd Floor</option>
                                        </optgroup>
                                        <optgroup label="Special Rooms">
                                            <option value="AVR" {% if incident.location == 'AVR' %}selected{% endif %}>AVR</option>
                                            <option value="Faculty" {% if incident.location == 'Faculty' %}selected{% endif %}>Faculty</option>
                                            <option value="Admin Office" {% if incident.location == 'Admin Office' %}selected{% endif %}>Admin Office</option>
                                            <option value="TLE Room/Canteen" {% if incident.location == 'TLE Room/Canteen' %}selected{% endif %}>TLE Room/Canteen</option>
                                        </optgroup>
                                    </select>
                                </div>

                                <div>
                                    <label><strong>Subject</strong></label>
                                    <select name="subject" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                                        <option value="Theft" {% if incident.subject == 'Theft' %}selected{% endif %}>Theft</option>
                                        <option value="Missing" {% if incident.subject == 'Missing' %}selected{% endif %}>Missing</option>
                                        <option value="Damage of Property" {% if incident.subject == 'Damage of Property' %}selected{% endif %}>Damage of Property</option>
                                        <option value="Vandalism" {% if incident.subject == 'Vandalism' %}selected{% endif %}>Vandalism</option>
                                        <option value="Bullying/Fights" {% if incident.subject == 'Bullying/Fights' %}selected{% endif %}>Bullying/Fights</option>
                                        <option value="Accidental Injuries" {% if incident.subject == 'Accidental Injuries' %}selected{% endif %}>Accidental Injuries</option>
                                        <option value="Threats/Harassment" {% if incident.subject == 'Threats/Harassment' %}selected{% endif %}>Threats/Harassment</option>
                                        <option value="Cheating" {% if incident.subject == 'Cheating' %}selected{% endif %}>Cheating</option>
                                        <option value="Drugs" {% if incident.subject == 'Drugs' %}selected{% endif %}>Drugs</option>
                                        <option value="Suicide Incident" {% if incident.subject == 'Suicide Incident' %}selected{% endif %}>Suicide Incident</option>
                                        <option value="Building Maintenance Issues" {% if incident.subject == 'Building Maintenance Issues' %}selected{% endif %}>Building Maintenance Issues</option>
                                        <option value="Other/s" {% if incident.subject == 'Other/s' %}selected{% endif %}>Other/s</option>
                                    </select>
                                </div>
                            </div>

                            <div style="margin-top:16px;">
                                <label><strong>People Involved</strong></label>
                                <textarea name="people_involved" rows="3" placeholder="List people involved" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">{{ incident.people_involved }}</textarea>
                            </div>

                            <div style="margin-top:16px;">
                                <label><strong>Incident Description</strong></label>
                                <textarea name="incident" rows="4" placeholder="Describe the incident in detail" required style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">{{ incident.incident }}</textarea>
                            </div>

                            <div style="margin-top:16px;">
                                <label><strong>Request for Action</strong></label>
                                <select name="request_for_action" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                                    <option value="Counseling" {% if incident.request_for_action == 'Counseling' %}selected{% endif %}>Counseling</option>
                                    <option value="Mediation" {% if incident.request_for_action == 'Mediation' %}selected{% endif %}>Mediation</option>
                                    <option value="Incident Review" {% if incident.request_for_action == 'Incident Review' %}selected{% endif %}>Incident Review</option>
                                    <option value="Safety Inspection" {% if incident.request_for_action == 'Safety Inspection' %}selected{% endif %}>Safety Inspection</option>
                                    <option value="Notify Guardian" {% if incident.request_for_action == 'Notify Guardian' %}selected{% endif %}>Notify Guardian</option>
                                    <option value="Referral to Health Services" {% if incident.request_for_action == 'Referral to Health Services' %}selected{% endif %}>Referral to Health Services</option>
                                    <option value="Referral to Guidance" {% if incident.request_for_action == 'Referral to Guidance' %}selected{% endif %}>Referral to Guidance</option>
                                    <option value="Security Escort/Monitoring" {% if incident.request_for_action == 'Security Escort/Monitoring' %}selected{% endif %}>Security Escort/Monitoring</option>
                                    <option value="Documentation Update" {% if incident.request_for_action == 'Documentation Update' %}selected{% endif %}>Documentation Update</option>
                                    <option value="Other/s" {% if incident.request_for_action == 'Other/s' %}selected{% endif %}>Other/s</option>
                                </select>
                            </div>

                            <div style="margin-top:16px;">
                                <label><strong>Update File (Optional)</strong></label>
                                <input type="file" name="update_file" style="width:100%;">
                            </div>

                            <div style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end;">
                                <button type="button" id="cancel-update-open" class="btn">Cancel</button>
                                <button type="submit" name="update_open_case" class="btn btn-primary">Save Changes</button>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Confirmation Modal -->
                    <div id="delete-modal" class="modal" role="dialog" aria-hidden="true" style="display:none;">
                        <div class="modal-overlay" id="modal-overlay-delete" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);"></div>
                        <div class="modal-content" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:6px;max-width:500px;width:90%;z-index:1001;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                <h3 style="margin:0;color:#dc3545;">Delete Incident</h3>
                                <button type="button" id="close-delete-modal" aria-label="Close modal" style="background:none;border:0;font-size:18px;cursor:pointer;">✕</button>
                            </div>

                            <div style="margin-top:12px;">
                                <p>Are you sure you want to delete this incident? This action cannot be undone.</p>
                            </div>

                            <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end;">
                                <button type="button" id="cancel-delete" class="btn">Cancel</button>
                                <button type="submit" name="delete_incident" class="btn" style="background-color:#dc3545;color:white;">Delete</button>
                            </div>
                        </div>
                    </div>
                {% endif %}
        {% elif incident.status != 'closed' %}
            <!-- Pending case: show an Update Case button (only for admin/faculty) -->
            {% if user_role != 'student' %}
                <input type="text" name="incident_id" value="{{ incident.id }}" hidden>

                <button type="button" id="open-update-modal" class="btn btn-primary">Update Case</button>

                <a href="#" id="print-link" class=" text-center inline-block px-6 py-2 bg-blue-500 text-white font-semibold rounded-full shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    Print
                </a>

                <!-- Modal (hidden by default) -->
                <div id="update-modal" class="modal" role="dialog" aria-hidden="true" style="display:none;">
                    <div class="modal-overlay" id="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);"></div>
                    <div class="modal-content" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:6px;max-width:600px;width:90%;z-index:1001;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <h3 style="margin:0;">Update Case</h3>
                            <button type="button" id="close-update-modal" aria-label="Close modal" style="background:none;border:0;font-size:18px;cursor:pointer;">✕</button>
                        </div>

                        <div>
                            <label><strong>Status</strong></label>
                            <select name="status">
                                <option value="open" {% if incident.status == 'open' %}selected{% endif %}>Open</option>
                                <option value="pending" {% if incident.status == 'pending' %}selected{% endif %}>Ongoing</option>
                                <option value="closed" {% if incident.status == 'closed' %}selected{% endif %}>Closed</option>
                            </select>
                        </div>

                        <div style="margin-top:12px;">
                            <label><strong>Update Reason</strong></label>
                            <textarea name="update_reason" rows="4" placeholder="Describe the update or actions taken" required style="width:100%;"></textarea>
                        </div>

                        <div style="margin-top:12px;">
                            <label><strong>Attachment</strong></label>
                            <input type="file" name="update_file">
                        </div>

                        <!-- Removed the 'Close the case' checkbox per request -->

                        <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end;">
                            <button type="button" id="cancel-update" class="btn">Cancel</button>
                            <button type="submit" name="update_case" class="btn btn-primary">Save Update</button>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% else %}
            <!-- Closed case -->
            <p style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb; margin-top: 10px;">
                <strong>Note:</strong> This incident is closed and cannot be edited.
            </p>

            <a href="#" id="print-link" class=" text-center inline-block px-6 py-2 bg-blue-500 text-white font-semibold rounded-full shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                Print
            </a>
        {% endif %}
        </div>
        
        </form>

    <script>
    // Set print link if present
    (function(){
        var printLink = document.getElementById('print-link');
        if(printLink){
            printLink.href = window.location.href + 'print';
        }

        // Modal open/close behavior for pending cases
        var openBtn = document.getElementById('open-update-modal');
        var modal = document.getElementById('update-modal');
        var closeBtn = document.getElementById('close-update-modal');
        var cancelBtn = document.getElementById('cancel-update');
        var overlay = document.getElementById('modal-overlay');

        function showModal(){
            if(modal){
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden','false');
                // focus first textarea for accessibility
                var ta = modal.querySelector('textarea'); if(ta) ta.focus();
            }
        }

        function hideModal(){
            if(modal){
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden','true');
            }
        }

        if(openBtn){ openBtn.addEventListener('click', function(e){ e.preventDefault(); showModal(); }); }
        if(closeBtn){ closeBtn.addEventListener('click', function(){ hideModal(); }); }
        if(cancelBtn){ cancelBtn.addEventListener('click', function(){ hideModal(); }); }
        if(overlay){ overlay.addEventListener('click', function(){ hideModal(); }); }

        // Modal handlers for open cases (Update)
        var openBtnOpen = document.getElementById('open-update-modal-open');
        var modalOpen = document.getElementById('update-modal-open');
        var closeBtnOpen = document.getElementById('close-update-modal-open');
        var cancelBtnOpen = document.getElementById('cancel-update-open');
        var overlayOpen = document.getElementById('modal-overlay-open');

        function showModalOpen(){
            if(modalOpen){
                modalOpen.style.display = 'block';
                modalOpen.setAttribute('aria-hidden','false');
                var ta = modalOpen.querySelector('textarea'); if(ta) ta.focus();
            }
        }

        function hideModalOpen(){
            if(modalOpen){
                modalOpen.style.display = 'none';
                modalOpen.setAttribute('aria-hidden','true');
            }
        }

        if(openBtnOpen){ openBtnOpen.addEventListener('click', function(e){ e.preventDefault(); showModalOpen(); }); }
        if(closeBtnOpen){ closeBtnOpen.addEventListener('click', function(){ hideModalOpen(); }); }
        if(cancelBtnOpen){ cancelBtnOpen.addEventListener('click', function(){ hideModalOpen(); }); }
        if(overlayOpen){ overlayOpen.addEventListener('click', function(){ hideModalOpen(); }); }

        // Modal handlers for delete
        var deleteBtnOpen = document.getElementById('delete-incident-btn');
        var modalDelete = document.getElementById('delete-modal');
        var closeBtnDelete = document.getElementById('close-delete-modal');
        var cancelBtnDelete = document.getElementById('cancel-delete');
        var overlayDelete = document.getElementById('modal-overlay-delete');

        function showModalDelete(){
            if(modalDelete){
                modalDelete.style.display = 'block';
                modalDelete.setAttribute('aria-hidden','false');
            }
        }

        function hideModalDelete(){
            if(modalDelete){
                modalDelete.style.display = 'none';
                modalDelete.setAttribute('aria-hidden','true');
            }
        }

        if(deleteBtnOpen){ deleteBtnOpen.addEventListener('click', function(e){ e.preventDefault(); showModalDelete(); }); }
        if(closeBtnDelete){ closeBtnDelete.addEventListener('click', function(){ hideModalDelete(); }); }
        if(cancelBtnDelete){ cancelBtnDelete.addEventListener('click', function(){ hideModalDelete(); }); }
        if(overlayDelete){ overlayDelete.addEventListener('click', function(){ hideModalDelete(); }); }

        // close on Esc
        document.addEventListener('keydown', function(e){ 
            if(e.key === 'Escape'){ 
                hideModal(); 
                hideModalOpen(); 
                hideModalDelete(); 
            } 
        });
    })();
    </script>

    <!-- Runtime update script -->
    <script>
    function updateRuntime() {
        const runtimeDisplay = document.getElementById('runtime-display');
        if (!runtimeDisplay) return;
        
        const createdDate = new Date(runtimeDisplay.getAttribute('data-created'));
        const now = new Date();
        const diff = now - createdDate;
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        let runtimeText = '';
        if (days > 0) {
            runtimeText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        } else if (hours > 0) {
            runtimeText = `${hours}h ${minutes}m ${seconds}s`;
        } else if (minutes > 0) {
            runtimeText = `${minutes}m ${seconds}s`;
        } else {
            runtimeText = `${seconds}s`;
        }
        
        runtimeDisplay.textContent = runtimeText;
    }
    
    // Update immediately and then every second
    if (document.getElementById('runtime-display')) {
        updateRuntime();
        setInterval(updateRuntime, 1000);
    }
    </script>
    
    <!-- Case updates history -->
    <div class="updates-history" style="margin-top:24px;padding:16px;border-top:1px solid #e6e6e6;">
        <h3 style="margin-bottom:12px;">Case Updates</h3>
        {% if incident.updates.all %}
            <ul style="list-style:none;padding:0;">
            {% for u in incident.updates.all %}
                <li style="padding:10px 0;border-bottom:1px solid #f0f0f0;">
                    <div style="font-size:13px;color:#666;margin-bottom:6px;"><strong>{{ u.created_at }}</strong> by {{ u.created_by }} {% if u.close_case %}<span style="color:#a00;margin-left:8px;">(Closed case)</span>{% endif %}</div>
                    <div style="margin-bottom:6px;white-space:pre-wrap;">{{ u.reason }}</div>
                    {% if u.file %}
                        <div>
                            <a href="{{ u.file.url }}" download="{{ u.file.name }}" style="display:inline-block;padding:6px 12px;background:#6c757d;color:#fff;border-radius:6px;text-decoration:none;font-weight:600;font-size:13px;" rel="noopener">Download attachment</a>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p style="color:#666;">No updates yet.</p>
        {% endif %}
    </div>
{% endblock %}
